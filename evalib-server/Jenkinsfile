import groovy.json.JsonOutput

node {	
	def dockerImage
	
	stage('checkout') {
		checkout scm
	}
  
	stage('build-artifacts') {		
		def mavenImage = docker.image('maven:3.5-jdk-8')
		mavenImage.inside("-v $HOME/.m2:/root/.m2") {
			sh """
				cd evalib-server
				mvn clean package
			"""
		}
	}
	
	stage('build-docker') {
		dockerImage = docker.build("jamietao/evalib", "evalib-server/docker/")
	}
	
	stage('test') {
		steps {
			echo 'Testing...'
		}
	}
	
	stage('publish-docker') {
		docker.withRegistry('https://hub.docker.com/', 'docker-hub-credentials') {
			dockerImage.push('${env.BUILD_NUMBER}')
			dockerImage.push('latest')
		}
	}
	
	stage('cleanup') {
		// removing the image locally that has been pushed into docker hub
		sh 'docker rmi jamietao/evalib'
	}
	
	post {
		always {
			echo 'post section...'
			archiveArtifacts artifacts: 'evalib-server/evalib-web-admin/target/*.jar'
		}
		failure {
			echo 'failure...'
		}
    }
}