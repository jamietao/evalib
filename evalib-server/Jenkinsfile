import groovy.json.JsonOutput

node {
    agent {
		docker {
			image 'maven:3.5-jdk-8'
			args '-v $HOME/.m2:/root/.m2'
		}
	}
	
	def dockerImage
	
	stages {
		stage('Build') {
			steps {
				echo 'Building #${env.BUILD_NUMBER}...'
				sh 'cd evalib-server && mvn clean package'
				dockerImage = docker.build("jamietao/evalib", "-f evalib-server/docker/Dockerfile")
			}
		}
		stage('Test') {
			steps {
				echo 'Testing...'
			}
		}
		
		stage('Docker') {
			docker.withRegistry('https://hub.docker.com/', 'docker-hub-credentials') {
				dockerImage.push('${env.BUILD_NUMBER}')
				dockerImage.push('latest')
			}
		}
   }
   post {
		always {
			echo 'post section...'
			archiveArtifacts artifacts: 'evalib-server/evalib-web-admin/target/*.jar'
		}
		failure {
			echo 'failure...'
		}
   }
}