import groovy.json.JsonOutput

node {	
	def dockerImage
	
	stage('checkout') {
		checkout scm
	}
  
	stage('Build') {		
		docker.image('maven:3.5-jdk-8').withRun('-v $HOME/.m2:/root/.m2') { c->
			sh 'cd evalib-server'
			sh 'mvn clean package'
			dockerImage = docker.build("jamietao/evalib", "-f evalib-server/docker/Dockerfile")
		}
	}
	
	stage('Test') {
		steps {
			echo 'Testing...'
		}
	}
	
	stage('Docker') {
		docker.withRegistry('https://hub.docker.com/', 'docker-hub-credentials') {
			dockerImage.push('${env.BUILD_NUMBER}')
			dockerImage.push('latest')
		}
	}
	
	stage('leanup') {
		// removing the image locally that has been pushed into docker hub
		sh 'docker rmi jamietao/evalib'
	}
	
	post {
		always {
			echo 'post section...'
			archiveArtifacts artifacts: 'evalib-server/evalib-web-admin/target/*.jar'
		}
		failure {
			echo 'failure...'
		}
    }
}